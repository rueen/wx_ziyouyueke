<!--pages/courseDetail/courseDetail.wxml-->
<navBar title="è¯¾ç¨‹è¯¦æƒ…" />
<layout class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- è¯¾ç¨‹è¯¦æƒ…å†…å®¹ -->
  <view wx:else class="course-detail-content">
    <!-- è¯¾ç¨‹ä¿¡æ¯å¡ç‰‡ -->
    <view class="course-card">
      <!-- äººå‘˜ä¿¡æ¯ -->
      <view class="person-info">
        <view class="person-avatar">
          <image src="{{courseInfo.displayAvatar}}" class="avatar-img"></image>
        </view>
        <view class="person-details">
          <text class="person-name">{{courseInfo.displayName}}</text>
          <text class="person-role">{{courseInfo.displayRole}}</text>
        </view>
        <!-- è¯¾ç¨‹çŠ¶æ€ -->
        <view class="status-badge status-{{courseInfo.status}}">
          <text class="status-text">{{courseInfo.status === 'pending' ? (
            courseInfo.isCreatedByCurrentUser ? (
              userRole === 'coach' ? 'å¾…å­¦å‘˜ç¡®è®¤' : 'å¾…æ•™ç»ƒç¡®è®¤'
            ) : 'å¾…ç¡®è®¤'
          ) : 
            courseInfo.status === 'confirmed' ? 'å·²ç¡®è®¤' : 
            courseInfo.status === 'completed' ? 'å·²å®Œæˆ' : 
            courseInfo.status === 'cancelled' ? 'å·²å–æ¶ˆ' : 'æœªçŸ¥çŠ¶æ€'}}</text>
        </view>
      </view>

      <!-- è¯¾ç¨‹è¯¦ç»†ä¿¡æ¯ -->
      <view class="course-info-section">
        <view class="info-item">
          <view class="info-icon">ğŸ“…</view>
          <view class="info-content">
            <text class="info-label">ä¸Šè¯¾æ—¶é—´</text>
            <text class="info-value">{{courseInfo.time}}</text>
          </view>
        </view>

        <view class="info-item">
          <view class="info-icon">ğŸ“</view>
          <view class="info-content">
            <text class="info-label">ä¸Šè¯¾åœ°ç‚¹</text>
            <text class="info-value">{{courseInfo.location}}</text>
          </view>
        </view>

        <view class="info-item" wx:if="{{courseInfo.remark}}">
          <view class="info-icon">ğŸ“</view>
          <view class="info-content">
            <text class="info-label">è¯¾ç¨‹å¤‡æ³¨</text>
            <text class="info-value">{{courseInfo.remark}}</text>
          </view>
        </view>

        <view class="info-item" wx:if="{{courseInfo.createTime}}">
          <view class="info-icon">â°</view>
          <view class="info-content">
            <text class="info-label">é¢„çº¦æ—¶é—´</text>
            <text class="info-value">{{courseInfo.createTime}}</text>
          </view>
        </view>

        <!-- æ˜¾ç¤ºå–æ¶ˆåŸå›  -->
        <view class="info-item" wx:if="{{courseInfo.status === 'cancelled' && courseInfo.cancelReason}}">
          <view class="info-icon">âŒ</view>
          <view class="info-content">
            <text class="info-label">å–æ¶ˆåŸå› </text>
            <text class="info-value cancel-reason">{{courseInfo.cancelReason}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</layout>

<!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
<view wx:if="{{!loading && courseInfo}}" class="bottom-actions">
  <!-- å¾…ç¡®è®¤çŠ¶æ€çš„æŒ‰é’® -->
  <view wx:if="{{courseInfo.status === 'pending'}}" class="action-buttons">
    <!-- å¦‚æœæ˜¯è¯¾ç¨‹åˆ›å»ºäººï¼Œåªæ˜¾ç¤ºå–æ¶ˆæŒ‰é’® -->
    <view wx:if="{{courseInfo.isCreatedByCurrentUser}}" class="single-button">
      <button class="action-btn cancel-btn" 
              bindtap="onShowCancelModal">å–æ¶ˆè¯¾ç¨‹</button>
    </view>
    <!-- å¦‚æœä¸æ˜¯è¯¾ç¨‹åˆ›å»ºäººï¼Œæ˜¾ç¤ºå–æ¶ˆå’Œç¡®è®¤æŒ‰é’® -->
    <view wx:else class="button-group">
      <button class="action-btn cancel-btn" 
              bindtap="onShowCancelModal">å–æ¶ˆè¯¾ç¨‹</button>
      <button class="action-btn confirm-btn" 
              bindtap="onConfirmCourse">ç¡®è®¤è¯¾ç¨‹</button>
    </view>
  </view>
  
  <!-- å·²ç¡®è®¤çŠ¶æ€çš„æŒ‰é’® -->
  <view wx:elif="{{courseInfo.status === 'confirmed'}}" class="action-buttons">
    <!-- å­¦å‘˜è§†è§’ï¼šæŸ¥çœ‹è¯¾ç¨‹ç å’Œå–æ¶ˆæŒ‰é’® -->
    <view wx:if="{{userRole === 'student'}}" class="button-group">
      <button class="action-btn cancel-btn" 
              bindtap="onShowCancelModal">å–æ¶ˆè¯¾ç¨‹</button>
      <button class="action-btn primary-btn" 
              bindtap="onViewCourseCode">æŸ¥çœ‹è¯¾ç¨‹ç </button>
    </view>
    
    <!-- æ•™ç»ƒè§†è§’ï¼šå–æ¶ˆå’Œæ ¸é”€æŒ‰é’® -->
    <view wx:if="{{userRole === 'coach'}}" class="button-group">
      <button class="action-btn cancel-btn" 
              bindtap="onShowCancelModal">å–æ¶ˆè¯¾ç¨‹</button>
      <button class="action-btn verify-btn" 
              bindtap="onScanVerify">æ‰«ç æ ¸é”€</button>
    </view>
  </view>
</view>

<!-- å–æ¶ˆåŸå› æ¨¡æ€æ¡† -->
<view class="cancel-modal {{showCancelModal ? 'show' : ''}}" wx:if="{{showCancelModal}}">
  <view class="modal-overlay" bindtap="onHideCancelModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">å–æ¶ˆè¯¾ç¨‹</text>
      <text class="modal-close" bindtap="onHideCancelModal">âœ•</text>
    </view>
    <view class="modal-body">
      <textarea class="cancel-reason-input" 
                placeholder="è¯·è¾“å…¥å–æ¶ˆåŸå› ..." 
                value="{{cancelReason}}" 
                bindinput="onCancelReasonInput"
                maxlength="200"
                auto-height></textarea>
      <view class="char-count">{{cancelReason.length}}/200</view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn cancel-modal-btn" bindtap="onHideCancelModal">å–æ¶ˆ</button>
      <button class="modal-btn confirm-modal-btn active" 
              bindtap="onConfirmCancel">ç¡®è®¤å–æ¶ˆ</button>
    </view>
  </view>
</view>

<!-- è¯¾ç¨‹ç å¼¹çª— -->
<view class="course-code-modal {{showCourseCodeModal ? 'show' : ''}}" wx:if="{{showCourseCodeModal}}">
  <view class="modal-overlay" bindtap="onHideCourseCodeModal"></view>
  <view class="modal-content course-code-content">
    <view class="modal-header">
      <text class="modal-title">è¯¾ç¨‹ç </text>
      <text class="modal-close" bindtap="onHideCourseCodeModal">âœ•</text>
    </view>
    <view class="modal-body course-code-body">
      <!-- äºŒç»´ç åŒºåŸŸ -->
      <view class="qr-code-container">
        <view class="qr-code-placeholder">
          <text class="qr-code-text">è¯¾ç¨‹äºŒç»´ç </text>
          <!-- äºŒç»´ç Canvas -->
          <canvas 
            canvas-id="qrcode-canvas" 
            class="qr-code-canvas">
          </canvas>
          <!-- äºŒç»´ç å›¾ç‰‡æ˜¾ç¤º -->
          <image 
            wx:if="{{qrCodeImagePath}}"
            src="{{qrCodeImagePath}}" 
            class="qr-code-image"
            mode="aspectFit">
          </image>
        </view>
        <text class="qr-tips">è¯·å‘æ•™ç»ƒå‡ºç¤ºæ­¤äºŒç»´ç è¿›è¡Œè¯¾ç¨‹æ ¸é”€</text>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn confirm-modal-btn full-width" 
              bindtap="onHideCourseCodeModal">å…³é—­</button>
    </view>
  </view>
</view> 