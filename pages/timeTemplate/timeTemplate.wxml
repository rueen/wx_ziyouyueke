<!--pages/timeTemplate/timeTemplate.wxml-->
<navBar title="时间模板" />
<layout>
  <view class="container">
    <!-- 预约设置 -->
    <view class="settings-section">
      <view class="section-header">
        <text class="section-title">预约设置</text>
        <text class="edit-btn" bindtap="onShowSettingsForm">编辑</text>
      </view>
      <view class="settings-content">
        <view class="setting-item">
          <text class="setting-label">是否启用</text>
          <switch 
            class="setting-switch" 
            checked="{{templateEnabled}}" 
            bindchange="onTemplateToggle"
          />
        </view>
        <view class="setting-item">
          <text class="setting-label">最多可预约天数</text>
          <text class="setting-value">{{bookingSettings.maxAdvanceDays}}天</text>
        </view>
        <view class="setting-item">
          <text class="setting-label">同时段最多可预约人数</text>
          <text class="setting-value">{{bookingSettings.maxAdvanceNums}}人</text>
        </view>
      </view>
    </view>

    <!-- 模板状态提示 -->
    <view class="template-status" wx:if="{{!templateEnabled && timeSlotTemplate.length > 0}}">
      <text class="status-text">⚠️ 当前模板已禁用，学员无法预约</text>
    </view>

    <view class="settings-section">
      <view class="section-header">
        <text class="section-title">
          <text>时间段类型</text>
        </text>
        <text class="edit-btn" bind:tap="handleEditTimeType" wx:if="{{!isEditTimeType}}">编辑</text>
      </view>
      <view class="tips">
        <text class="tips-text">切换时间段类型可能导致部分课程在课表中不显示</text>
      </view>
      <view class="time-type">
        <radio-group
          class="time-type-radio-group"
          bindchange="timeTypeRadioChange">
          <label wx:for="{{timeTypeArr}}" wx:key="type">
            <radio value="{{item.type}}" checked="{{item.type === time_type}}" disabled="{{!isEditTimeType}}" />
            <text class="setting-value">{{item.text}}</text>
          </label>
        </radio-group>
      </view>
      <!-- 全日程统一模板 -->
      <block wx:if="{{time_type === 0}}">
        <!-- 时间段模板 -->
        <view class="template-section">
          <view class="section-header">
            <text class="section-title-small">时间段</text>
            <text class="add-btn" bindtap="onShowAddForm" wx:if="{{isEditTimeType}}">添加</text>
          </view>
          <view class="time-slots" wx:if="{{timeSlotTemplate.length > 0}}">
            <view class="time-slot" wx:for="{{timeSlotTemplate}}" wx:key="id">
              <view class="time-info">
                <text class="time-text">{{item.startTime}} - {{item.endTime}}</text>
              </view>
              <text class="delete-btn" bindtap="onDeleteTimeSlot" data-slot-index="{{index}}" wx:if="{{isEditTimeType}}">删除</text>
            </view>
          </view>
        </view>
        <!-- 日期模板 -->
        <view class="data-section">
          <view class="section-header">
            <text class="section-title-small">周历</text>
          </view>
          <view class="date-slots">
            <view class="date-slot" wx:for="{{dateSlotTemplate}}" wx:key="id">
              <text>{{ item.text }}</text>
              <switch checked="{{item.checked}}" data-index="{{index}}" disabled="{{!isEditTimeType}}" bindchange="switchDateChange" />
            </view>
          </view>
        </view>
      </block>

      <!-- 按周历循环模板 -->
      <block wx:if="{{time_type === 1}}">
        <view class="data-section">
          <view class="section-header">
            <text class="section-title-small">周历</text>
          </view>
          <view class="date-slots">
            <view wx:for="{{weekSlotTemplate}}" wx:key="id">
              <view class="date-slot">
                <text>{{ item.text }}</text>
                <switch checked="{{item.checked}}" data-index="{{index}}" disabled="{{!isEditTimeType}}" bindchange="switchWeekSlotChange"/>
              </view>
              <view class="template-section" wx:if="{{item.checked}}">
                <view class="time-slots" wx:if="{{item.time_slots.length > 0}}">
                  <view class="time-slot" wx:for="{{item.time_slots}}" wx:key="id" wx:for-item="timeSlot" wx:for-index="slotIndex">
                    <view class="time-info">
                      <text class="time-text">{{timeSlot.startTime}} - {{timeSlot.endTime}}</text>
                    </view>
                    <text class="delete-btn" bindtap="onDeleteTimeSlot" data-slot-index="{{slotIndex}}" data-week-index="{{index}}" wx:if="{{isEditTimeType}}">删除</text>
                  </view>
                </view>
                <view class="section-header" wx:if="{{isEditTimeType}}">
                  <text class="add-btn" bindtap="onShowAddForm" data-week-index="{{index}}">+ 时间段</text>
                </view>
              </view>
            </view>

          </view>
        </view>
      </block>

      <!-- 自由日程模板 -->
      <block wx:if="{{time_type === 2}}">
        
      </block>
      
    </view>
  </view>

  <!-- 操作按钮 -->
  <view wx:if="{{isEditTimeType}}" class="action-buttons">
    <button class="cancel-button" bindtap="handleCancelTimeType">取消</button>
    <button class="save-button" bindtap="handleSaveTimeType" loading="{{isSaving}}" disabled="{{isSaving}}">{{isSaving ? '保存中...' : '保存'}}</button>
  </view>

</layout>

<!-- 预约设置弹窗 -->
<view class="modal-mask" wx:if="{{showSettingsForm}}" bindtap="onHideSettingsForm">
  <view class="modal-container" catchtap="onPreventClose">
    <view class="modal-header">
      <text class="modal-title">预约设置</text>
      <text class="modal-close" bindtap="onHideSettingsForm">×</text>
    </view>
    <view class="modal-content">
      <view class="form-item">
        <text class="form-label">最多可预约天数</text>
        <input class="form-input" 
               type="number" 
               value="{{tempMaxAdvanceDays}}" 
               bindinput="onMaxAdvanceDaysChange" 
               placeholder="请输入天数" />
      </view>
      <view class="form-item">
        <text class="form-label">同时段最多可预约人数</text>
        <input class="form-input" 
               type="number" 
               value="{{tempMaxAdvanceNums}}" 
               bindinput="onMaxAdvanceNumsChange" 
               placeholder="请输入人数" />
      </view>
    </view>
    <view class="modal-footer">
      <button class="cancel-btn" bindtap="onHideSettingsForm">取消</button>
      <button class="confirm-btn" bindtap="onSaveSettings">保存</button>
    </view>
  </view>
</view>

<!-- 添加时间段弹窗 -->
<view class="modal-mask" wx:if="{{showAddForm}}" bindtap="onHideAddForm">
  <view class="modal-container" catchtap="onPreventClose">
    <view class="modal-header">
      <text class="modal-title">添加时间段</text>
      <text class="modal-close" bindtap="onHideAddForm">×</text>
    </view>
    <view class="modal-content">
      <view class="form-item">
        <text class="form-label">开始时间</text>
        <picker mode="time" 
                value="{{newStartTime}}" 
                bindchange="onStartTimeChange">
          <view class="picker-view">
            <text class="picker-text">{{newStartTime || '选择时间'}}</text>
          </view>
        </picker>
      </view>
      <view class="form-item">
        <text class="form-label">结束时间</text>
        <picker mode="time" 
                value="{{newEndTime}}" 
                bindchange="onEndTimeChange">
          <view class="picker-view">
            <text class="picker-text">{{newEndTime || '选择时间'}}</text>
          </view>
        </picker>
      </view>
    </view>
    <view class="modal-footer">
      <button class="cancel-btn" bindtap="onHideAddForm">取消</button>
      <button class="confirm-btn" bindtap="onConfirmAdd">确定</button>
    </view>
  </view>
</view> 