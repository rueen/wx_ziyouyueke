<!--pages/groupCourses/groupCourses.wxml-->
<ghostNav />
<layout>
  <view class="user-section">
    <view class="user-info" bindtap="onBindCoach">
      <view class="user-avatar">
        <image src="{{coachData.avatar_url}}" class="avatar-img"></image>
      </view>
      <view class="user-details">
        <view class="username-row">
          <text class="username">{{coachData.nickname}}</text>
          <!-- <text class="iconfont icon-arrow-r arrow-icon"></text> -->
        </view>
        <text class="user-desc">{{coachData.intro}}</text>
      </view>
    </view>
    <view class="share-btn" bind:tap="onShare">
      <text class="iconfont icon-share-line share-icon"></text>
    </view>
  </view>
  <view class="container">
    <!-- 筛选标签 -->
    <view class="tabs">
      <view 
        wx:for="{{tabs}}" 
        wx:key="key"
        class="tab-item {{activeTab === item.status ? 'active' : ''}}"
        data-status="{{item.status}}"
        bindtap="onTabChange"
      >
        {{item.name}}
      </view>
    </view>

    <!-- 课程列表 -->
    <view class="courses-container">
      <view wx:if="{{courses.length > 0}}">
        <view 
          wx:for="{{courses}}" 
          wx:key="id"
          class="course-card"
        >
          <view
            class="course-card-wrap"
            data-course="{{item}}"
            bindtap="onCourseTap"
          >
            <!-- 课程状态标签 -->
            <view class="status-tag status_{{item.status}}">
              <text wx:if="{{item.status === 0}}">未发布</text>
              <text wx:if="{{item.status === 1}}">报名中</text>
              <text wx:if="{{item.status === 2}}">
                <text wx:if="{{!!item.cancel_reason}}">已取消</text>
                <text wx:else>已结束</text>
              </text>
            </view>

            <!-- 课程图片 -->
            <view class="course-image">
              <image src="{{item.image}}" mode="aspectFill" lazy-load="{{true}}"></image>
            </view>

            <!-- 课程信息 -->
            <view class="course-info">
              <view class="course-title">
                <text>{{item.title}}</text>
              </view>
              <!-- 时间信息 -->
              <view class="course-meta">
                <view class="meta-item">
                  <text class="iconfont icon-shijianmoban icon"></text>
                  <text class="text">{{item.date}} {{item.weekday}} {{item.time}}</text>
                </view>
                <view class="meta-item">
                  <text class="iconfont icon-location icon"></text>
                  <text class="text">{{item.address.name}}</text>
                </view>
              </view>
              <view class="price">
                <text>{{item.price}}</text>
              </view>
            </view>
          </view>
          
          <view class="course-bottom">
            <!-- 参与者信息 -->
            <view
              class="participants"
              data-course="{{item}}"
              catch:tap="viewRegistrations"
            >
              <view class="avatar-list">
                <image src="{{applicant.student.avatar_url || 'https://ziyouyueke.oss-cn-hangzhou.aliyuncs.com/avatar/defaultAvatar.png'}}" mode="aspectFill" wx:for="{{item.registrations}}" wx:key="*this" wx:for-item="applicant" wx:if="{{index < 6}}" class="avatar"/>
              </view>
              <text class="participant-count">{{item.current_participants}}人已报名</text>
            </view>

            <!-- 课程所有者操作按钮 -->
            <view wx:if="{{isOwner}}" class="action-buttons">
              <button
                wx:if="{{item.status !== 0}}"
                class="action-btn cancel"
                data-course="{{item}}"
                catch:tap="viewRegistrations"
              >查看报名</button>
              <button
                wx:if="{{item.isCanCancel}}"
                class="action-btn cancel"
                data-course="{{item}}"
                catch:tap="onCancelCourse"
              >取消</button>
              <button
                wx:if="{{item.status === 0 || (item.status === 2 && item.current_participants === 0)}}"
                class="action-btn cancel"
                data-course="{{item}}"
                catch:tap="onDeleteCourse"
              >删除</button>
            </view>
            <!-- 非课程所有者操作按钮 -->
            <view class="action-buttons" data-course="{{item}}" bindtap="onCourseTap" wx:else>
              <button wx:if="{{item.status === 1}}" class="action-btn registration">立即报名</button>
            </view>
          </view>

          <view class="cancel_reason" wx:if="{{!!item.cancel_reason}}">取消原因：{{item.cancel_reason}}</view>

        </view>
      </view>

      <!-- 空状态 -->
      <emptyState 
        wx:if="{{courses.length === 0 && !isLoading}}">
      </emptyState>

      <!-- 加载状态 -->
      <view class="loading-state" wx:if="{{isLoading}}">
        <text class="loading-text">加载中...</text>
      </view>
    </view>

    <!-- 新增团课按钮 -->
    <view class="add-course-btn-container" wx:if="{{isOwner}}">
      <button class="add-course-btn" bindtap="onAddCourseTap">新增团课</button>
    </view>
  </view>

  <!-- 取消团课模态框 -->
  <modal 
    show="{{showCancelModal}}" 
    title="取消原因"
    position="bottom"
    bind:close="onCloseCancelModal"
  >
    <view class="cancel-modal-content">
      <view class="cancel-reason-section">
        <textarea 
          class="cancel-reason-input"
          placeholder="请输入取消团课的原因"
          value="{{cancelReason}}"
          bindinput="onCancelReasonInput"
          maxlength="200"
          auto-height
        ></textarea>
      </view>
      <view class="cancel-modal-actions">
        <button class="cancel-btn" bindtap="onCloseCancelModal">取消</button>
        <button class="confirm-btn" bindtap="onConfirmCancel">确认取消</button>
      </view>
    </view>
  </modal>

  <!-- 分享弹窗 -->
  <shareModal 
    show="{{showShareModal}}"
    bind:close="onCloseShareModal"
    bind:select="onSelectShareType"
  />

  <!-- 隐藏的Canvas，用于绘制海报 -->
  <canvas 
    type="2d" 
    id="posterCanvas" 
    style="position: fixed; left: -9999px; top: -9999px; width: 375px; height: 667px;"
  ></canvas>
</layout>