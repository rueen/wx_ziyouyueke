<!--pages/groupCourseDetail/groupCourseDetail.wxml-->
<wxs module="_filters">
module.exports = {
  getCoursePrice: function(course){
    switch (course.price_type) {
      case 1: // 扣课时
        return course.lesson_cost + '课时'
      case 2: // 金额展示
        return '¥' + course.price_amount
      case 3: // 免费
        return '免费'
      default:
      return '--'
    }
  },
  formatRegistrationTime: function(dateStr) {
    if (!dateStr) return ''
    
    var date = getDate(dateStr)
    var now = getDate()
    var diff = now.getTime() - date.getTime()
    
    // 小于1分钟
    if (diff < 60 * 1000) {
      return '刚刚'
    }
    
    // 小于1小时
    if (diff < 60 * 60 * 1000) {
      var minutes = Math.floor(diff / (60 * 1000))
      return minutes + '分钟前'
    }
    
    // 小于1天
    if (diff < 24 * 60 * 60 * 1000) {
      var hours = Math.floor(diff / (60 * 60 * 1000))
      return hours + '小时前'
    }
    
    // 小于7天
    if (diff < 7 * 24 * 60 * 60 * 1000) {
      var days = Math.floor(diff / (24 * 60 * 60 * 1000))
      return days + '天前'
    }
    
    // 超过7天显示具体日期
    var month = (date.getMonth() + 1).toString()
    var day = date.getDate().toString()
    if (month.length === 1) month = '0' + month
    if (day.length === 1) day = '0' + day
    return month + '-' + day
  }
}
</wxs>
<ghostNav />
<!-- 课程封面图片 -->
<view class="cover-section">
  <swiper
    class="swiper"
    wx:if="{{courseDetail.cover_images && courseDetail.cover_images.length}}"
    indicator-dots="true"
  >
    <block wx:for="{{courseDetail.cover_images}}" wx:key="*this">
      <swiper-item>
        <image
          class="cover-image" 
          src="{{item}}"
          mode="aspectFill"
        ></image>
      </swiper-item>
    </block>
  </swiper>
  <view wx:else class="cover-placeholder">
    <text class="placeholder-text">暂无封面</text>
  </view>
</view>
<view class="container">
  <!-- 课程状态标签 -->
  <view class="price-info">
    <view class="status-tag status_{{courseDetail.status}}">
      <text wx:if="{{courseDetail.status === 0}}">未发布</text>
      <text wx:if="{{courseDetail.status === 1}}">报名中</text>
      <text wx:if="{{courseDetail.status === 2}}">已结束</text>
    </view>
    <view class="price">
      <text>{{_filters.getCoursePrice(courseDetail)}}</text>
    </view>
  </view>
  
  <view class="course-title">{{courseDetail.title}}</view>
  <!-- 时间信息 -->
  <view class="time-info">
    <view class="time-item">
      <text>
        <text class="iconfont icon-shijianmoban time-icon"></text>
        <text class="time-text">{{courseDetail.showTime}}</text>
      </text>
      <text class="time-tag">{{courseDetail.duration}}分钟</text>
    </view>
  </view>

  <!-- 地址信息 -->
  <view wx:if="{{courseDetail.address}}" class="address-info" bindtap="onAddressTap">
    <text class="iconfont icon-locationfill address-icon"></text>
    <view class="address-details">
      <text class="address-name">{{courseDetail.address.name}}</text>
      <text class="address-desc">{{courseDetail.address.address}}</text>
    </view>
    <text class="iconfont icon-arrow-r"></text>
  </view>

  <!-- 报名信息 -->
  <view class="registration-info">
    <view class="section-title">报名信息</view>
    <view class="registration-details">
      <view class="registration-item">
        <text class="registration-label">报名范围：</text>
        <text class="registration-value">{{courseDetail.enrollment_scope === 1 ? '仅学员' : '所有人'}}</text>
      </view>
      <view class="registration-item">
        <text class="registration-label">成团人数：</text>
        <text class="registration-value">{{courseDetail.min_participants}} 人</text>
      </view>
      <view class="registration-item" bindtap="onShowRegistrationModal">
        <view class="participants">
          <view class="avatar-list">
            <image src="{{applicant.student.avatar_url || 'https://ziyouyueke.oss-cn-hangzhou.aliyuncs.com/avatar/defaultAvatar.png'}}" mode="aspectFill" wx:for="{{courseDetail.registrations}}" wx:key="*this" wx:for-item="applicant" wx:if="{{index < 6}}" class="avatar"/>
          </view>
          <text class="registration-label">{{courseDetail.current_participants}}人已报名</text>
        </view>
        <view class="registration-value">
          <text>剩余<text class="registration-left">{{courseDetail.max_participants - courseDetail.current_participants}}</text>个名额</text>
          <text class="iconfont icon-arrow-r"></text>
        </view>
      </view>
    </view>
  </view>

  <!-- 教练信息 -->
  <view class="coach-info" bindtap="onGroupCourses">
    <image 
      class="coach-avatar" 
      src="{{courseDetail.coach.avatar_url || '/images/defaultAvatar.png'}}"
    ></image>
    <view class="coach-details">
      <text class="coach-name">{{courseDetail.coach.nickname}}</text>
      <text class="coach-desc">教练</text>
    </view>
    <text class="iconfont icon-arrow-r"></text>
  </view>

  <!-- 课程详情 -->
  <view wx:if="{{courseDetail.content}}" class="content-section">
    <view class="section-title">课程详情</view>
    <view class="course-content">
      <text>{{courseDetail.content}}</text>
    </view>
    <view class="images-section">
      <image 
        wx:for="{{courseDetail.images}}" 
        wx:key="*this"
        class="detail-image"
        src="{{item}}"
        mode="widthFix"
        bindtap="previewImage"
        data-current="{{item}}"
        data-urls="{{courseDetail.images}}"
      ></image>
    </view>
  </view>

  <!-- 底部操作按钮 -->
  <view class="bottom-actions">
    <view class="action-buttons">
      <!-- 课程所有者操作按钮 -->
      <view wx:if="{{isOwner}}" class="owner-actions">
        <!-- 未发布课程：编辑、发布 -->
        <view wx:if="{{courseDetail.status === 0}}" class="button-group">
          <button class="action-btn editable" bindtap="onEditCourse">
            编辑课程
          </button>
          <button class="action-btn publish" bindtap="onPublishCourse">
            发布课程
          </button>
        </view>
        
        <!-- 已发布课程：编辑 -->
        <view wx:elif="{{courseDetail.status === 1}}" class="button-group">
          <button class="action-btn editable" bindtap="onEditCourse">
            编辑课程
          </button>
        </view>
      </view>
      
      <!-- 非课程所有者：报名相关按钮 -->
      <view wx:else class="student-actions">
        <!-- 分享按钮 -->
        <button class="action-btn share" open-type="share">
          <text class="iconfont icon-share-line share-icon"></text>
          <text>分享</text>
        </button>
        <!-- 报名/取消报名按钮 -->
        <button 
          wx:if="{{!isRegistered && courseDetail.status === 1 && courseDetail.current_participants < courseDetail.max_participants}}"
          class="action-btn registration"
          bindtap="onRegisterTap"
        >
          立即报名
        </button>
        
        <button 
          wx:elif="{{isRegistered}}"
          class="action-btn secondary"
          bindtap="onUnregisterTap"
        >
          取消报名
        </button>
        
        <button 
          wx:else
          class="action-btn disabled"
          disabled
        >
          {{courseDetail.current_participants >= courseDetail.max_participants ? '已满员' : '报名已结束'}}
        </button>
      </view>
    </view>
  </view>
</view>

<!-- 报名人员弹窗 -->
<view class="registration-modal" wx:if="{{showRegistrationModal}}">
  <view class="modal-mask" bindtap="onHideRegistrationModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">{{courseDetail.current_participants}}人已报名 | 剩余<text class="registration-left">{{courseDetail.max_participants - courseDetail.current_participants}}</text>个名额</text>
      <text class="iconfont icon-close modal-close" bindtap="onHideRegistrationModal"></text>
    </view>
    <scroll-view class="modal-body" scroll-y="true">
      <view class="participant-item" wx:for="{{courseDetail.registrations}}" wx:key="*this" wx:for-item="participant">
        <image 
          class="participant-avatar" 
          src="{{participant.student.avatar_url || 'https://ziyouyueke.oss-cn-hangzhou.aliyuncs.com/avatar/defaultAvatar.png'}}" 
          mode="aspectFill"
        />
        <view class="participant-info">
          <text class="participant-name">{{participant.student.nickname}}</text>
          <text class="participant-time">{{_filters.formatRegistrationTime(participant.created_at)}} 报名</text>
        </view>
      </view>
    </scroll-view>
  </view>
</view>
