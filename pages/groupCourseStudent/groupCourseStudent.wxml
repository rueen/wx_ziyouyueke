<!--pages/groupCourseStudent/groupCourseStudent.wxml-->
<navBar title="我报名的团课" />
<layout>
  <!-- 筛选标签 -->
  <view class="tabs">
    <view 
      wx:for="{{tabs}}" 
      wx:key="key"
      class="tab-item {{activeTab === item.status ? 'active' : ''}}"
      data-tab="{{item}}"
      bindtap="onTabChange"
    >
      {{item.name}}
    </view>
  </view>

  <!-- 课程列表 -->
  <view class="courses-container">
    <view wx:if="{{list.length > 0}}">
      <view
        class="course-card"
        wx:for="{{list}}" 
        wx:key="id"
      >
        <view
          class="course-card-wrap"
          bindtap="onCourseTap"
          data-course="{{item}}"
        >
          <!-- 课程状态标签 -->
          <view class="status-tag status_{{item.status}}">
            <text wx:if="{{item.status === 0}}">未发布</text>
            <text wx:if="{{item.status === 1}}">报名中</text>
            <text wx:if="{{item.status === 2}}">
              <text wx:if="{{!!item.cancel_reason}}">已取消</text>
              <text wx:else>已结束</text>
            </text>
          </view>

          <!-- 课程图片 -->
          <view class="course-image">
            <image src="{{item.image}}" mode="aspectFill" lazy-load="{{true}}"></image>
          </view>

          <!-- 课程信息 -->
          <view class="course-info">
            <view class="course-title">
              <text>{{item.title}}</text>
            </view>
            <!-- 时间信息 -->
            <view class="course-meta">
              <view class="meta-item">
                <text class="iconfont icon-shijianmoban icon"></text>
                <text class="text">{{item.date}} {{item.weekday}} {{item.time}}</text>
              </view>
              <view class="meta-item">
                <text class="iconfont icon-location icon"></text>
                <text class="text">{{item.address.name}}</text>
              </view>
            </view>
            <view class="price">
              <text>{{item.price}}</text>
            </view>
          </view>
        </view>
        <view class="course-bottom">
          <!-- 参与者信息 -->
          <view class="check_in_status">
            <text wx:if="{{item.check_in_status === 0}}">已报名</text>
            <text wx:if="{{item.check_in_status === 1}}">已签到</text>
            <text wx:if="{{item.check_in_status === 2}}">缺席</text>
          </view>
          <view>
            <button
              wx:if="{{item.status === 1 && item.check_in_status === 0}}"
              class="action-btn check-in"
              bind:tap="handleCheckIn"
              data-course="{{item}}"
            >签到</button>
          </view>
        </view>
        <view class="cancel_reason" wx:if="{{!!item.cancel_reason}}">取消原因：{{item.cancel_reason}}</view>
      </view>
    </view>

    <!-- 空状态 -->
    <emptyState 
      wx:if="{{list.length === 0 && !isLoading}}">
    </emptyState>

    <!-- 加载状态 -->
    <view class="loading-state" wx:if="{{isLoading}}">
      <text class="loading-text">加载中...</text>
    </view>
  </view>
</layout>

<!-- 签到二维码模态框 -->
<modal 
  show="{{showQrcodeModal}}" 
  title="签到码" 
  position="center"
  bind:close="onQrcodeModalClose"
>
  <view class="qrcode-modal">
    <!-- 二维码Canvas -->
    <canvas 
      canvas-id="qrcode-canvas" 
      class="qr-code-canvas">
    </canvas>
    <!-- 二维码图片显示 -->
    <image 
      wx:if="{{qrCodeImagePath}}"
      src="{{qrCodeImagePath}}" 
      class="qr-code-image"
      mode="aspectFit">
    </image>
    <text class="qr-tips">请向教练出示此二维码进行签到</text>
  </view>
</modal>