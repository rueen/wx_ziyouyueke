<!--pages/studentDetail/studentDetail.wxml-->
<navBar title="学员详情" />
<layout>
  <view class="container">
    <!-- 学员信息 -->
    <view class="student-header">
      <view class="student-avatar">
        <image src="{{studentData.student.avatar_url}}" class="avatar-img"></image>
      </view>
      <view class="student-info">
        <view class="student-name" wx:if="{{!isEditing}}">
          <view>
            <text>{{studentData.student_name}}</text>
            <text wx:if="{{studentData.student.phone}}"> - {{studentData.student.phone}}</text>
          </view>
          <text class="iconfont icon-editor edit-btn" wx:if="{{!isEditing && !!bookingStatus}}" bindtap="onStartEdit"></text>
        </view>
        <input wx:else class="student-name-input" type="text" value="{{studentName}}" bindinput="onStudentNameInput" />
        <view class="nickname" wx:if="{{studentData.student_name !== studentData.student.nickname}}">{{studentData.student.nickname}}</view>
        <view class="student-intro">{{studentData.student.intro}}</view>
        <view class="booking-status">
          <text class="booking-status-text">约课状态：</text>
          <switch checked="{{bookingStatus}}" bindchange="bookingStatusSwitchChange"/>
        </view>
      </view>
    </view>

    <!-- 课时信息 -->
    <view class="info-section">
      <view class="section-header">
        <text class="section-title">
          <text>剩余课时</text>
        </text>
        <text class="expire-date-title">到期时间</text>
      </view>
      <view class="tips" wx:if="{{!studentData.booking_status}}">
        <text class="tips-text">课程到期时间会在约课状态重新开启后顺延</text>
      </view>
      
      <view class="info-item" wx:for="{{studentData.category_lessons}}" wx:key="index">
        <view class="info-label">{{item.category.name}}：</view>
        <view class="course-item">
          <view wx:if="{{!isEditing}}" class="info-value">
            <text class="lessons-count active">{{item.remaining_lessons}}节</text>
          </view>
          <view wx:else class="edit-value-container">
            <input
              class="edit-input" 
              type="number" 
              value="{{item.remaining_lessons}}" 
              bindinput="onLessonsInput"
              data-id="{{item.category.id}}"
              placeholder="请输入课时数"></input>
            <text class="edit-unit">节</text>
          </view>
          <!-- 到期时间 -->
          <view wx:if="{{!isEditing}}" class="info-value">
            <text class="expire-date-text" wx:if="{{item.expire_date}}">{{item.expire_date}}</text>
            <text class="expire-date-text" wx:else>永久</text>
          </view>
          <view wx:else class="edit-value-container">
            <picker
              mode="date"
              bindchange="bindPickerChange"
              data-id="{{item.category.id}}"
            >
              <text class="expire-date-text" wx:if="{{lessons[index].expire_date}}">
                <text>{{lessons[index].expire_date}}</text>
                <text class="iconfont icon-arrow-r"></text>
              </text>
              <text class="expire-date-text" wx:else>
                <text>请选择</text>
                <text class="iconfont icon-arrow-r"></text>
              </text>
            </picker>
          </view>
        </view>
      </view>
      <view class="section-info">
        <text>可在“我的”->“课程分类”添加更多课程</text>
      </view>
    
    </view>

    <!-- 备注信息 -->
    <view class="info-section">
      <view class="section-header">
        <text class="section-title">教练备注</text>
      </view>
      
      <view class="remark-container">
        <view wx:if="{{!isEditing}}" class="remark-display">
          <text class="remark-text">{{studentData.coach_remark || '暂无备注'}}</text>
        </view>
        <textarea wx:else 
                  class="remark-textarea" 
                  placeholder="请输入学员备注" 
                  value="{{studentRemark}}" 
                  bindinput="onRemarkInput"
                  maxlength="200"></textarea>
      </view>
    </view>

    <!-- 上课记录 -->
    <view class="course-list active" bind:tap="handleViewCourseList" wx:if="{{!isEditing}}">
      <text>查看课程</text>
      <text class="iconfont icon-arrow-r arrow"></text>
    </view>

    <!-- 编辑状态的操作按钮 -->
    <view wx:if="{{isEditing}}" class="edit-actions">
      <button class="cancel-btn" bindtap="onCancelEdit">取消</button>
      <button class="save-btn" bindtap="onSave" loading="{{isSaving}}">
        {{isSaving ? '保存中...' : '保存'}}
      </button>
    </view>

    <!-- 操作按钮 -->
    <view wx:if="{{!isEditing}}" class="action-buttons">
      <button class="book-button" bindtap="onBookStudent" disabled="{{isUnbinding}}" wx:if="{{!!bookingStatus}}">立即约课</button>
      <button class="unbind-button" bindtap="onShowUnbindConfirm" disabled="{{isUnbinding}}">
        {{isUnbinding ? '解除中...' : '解除绑定'}}
      </button>
    </view>
  </view>
</layout>

<!-- 解除绑定确认弹窗 -->
<view class="modal-mask" wx:if="{{showUnbindModal}}" bindtap="onHideUnbindModal">
  <view class="modal-container" catchtap="onPreventClose">
    <view class="modal-header">
      <text class="modal-title">解除绑定</text>
      <text class="modal-close" bindtap="onHideUnbindModal">×</text>
    </view>
    <view class="modal-content">
      <view class="confirm-text">
        <text class="warning-icon">⚠️</text>
        <text class="confirm-message">确定要解除与"{{studentData.student.nickname}}"的师生关系吗？</text>
      </view>
      <view class="confirm-tips">
        <text class="tips-text">解除后将无法查看该学员信息，且无法恢复</text>
      </view>
    </view>
    <view class="modal-footer">
      <button class="cancel-btn" bindtap="onHideUnbindModal">取消</button>
      <button class="confirm-btn" bindtap="onConfirmUnbind" loading="{{isUnbinding}}">
        {{isUnbinding ? '解除中...' : '确认解除'}}
      </button>
    </view>
  </view>
</view>